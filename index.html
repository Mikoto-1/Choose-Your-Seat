<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电影院选座系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 30px;
        }

        .cinema-section {
            flex: 2;
            min-width: 960px;
            overflow-x: auto;
            overflow-y: visible;
        }

        .control-section {
            flex: 1;
            min-width: 350px;
        }

        .screen {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        #cinemaCanvas {
            border: 3px solid #ddd;
            border-radius: 10px;
            background: #f8f9fa;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            cursor: pointer;

            /* 固定尺寸，移除所有缩放相关属性 */
            width: 960px !important;
            height: 720px !important;

            /* 移除这些属性 */
            /* max-width: 100%; */
            /* max-height: 100vh; */
            /* object-fit: contain; */

            display: block;
            margin: 0 auto;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 2px solid #333;
            box-sizing: border-box;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .control-panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .group-members {
            margin-top: 15px;
        }

        .member-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .member-input input {
            flex: 1;
        }

        .member-input button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .selected-seats {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }

        .selected-seats h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .seat-info {
            font-size: 14px;
            color: #2c3e50;
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .cinema-config {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .cinema-config .form-group {
            flex: 1;
            min-width: 120px;
            margin-bottom: 10px;
        }

        .info-panel {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .ticket-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .total-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #e74c3c;
            text-align: right;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #dee2e6;
        }

        .ticket-records {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .ticket-category {
            margin-bottom: 15px;
        }

        .ticket-list {
            background: white;
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid #dee2e6;
            font-size: 13px;
            line-height: 1.4;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
        }

        .ticket-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .ticket-item:hover {
            background-color: #f0f0f0;
        }

        .ticket-item:last-child {
            border-bottom: none;
        }

        /* 用户登录相关样式 */
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
        }

        .login-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .logout-btn {
            background: none;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
            transition: color 0.3s;
        }

        .logout-btn:hover {
            color: white;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            position: relative;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: rgba(255, 255, 255, 0.8);
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .close:hover {
            color: white;
        }

        .modal-body {
            padding: 30px;
        }

        .form-tabs {
            display: flex;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: #666;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-field label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: bold;
            font-size: 14px;
        }

        .form-field input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-field input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .error-msg {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            min-height: 16px;
            padding: 4px 8px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
            border-left: 3px solid #e74c3c;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        .success-msg {
            color: #27ae60;
            font-size: 12px;
            margin-top: 5px;
            min-height: 16px;
            padding: 4px 8px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 4px;
            border-left: 3px solid #27ae60;
            display: none;
        }

        .success-msg.show {
            display: block;
        }

        /* 自定义滚动条样式 */
        .cinema-section::-webkit-scrollbar {
            height: 8px;
        }

        .cinema-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .cinema-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .cinema-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                min-width: 980px;
            }

            .main-content {
                flex-direction: column;
                gap: 20px;
            }

            .cinema-section {
                min-width: auto;
                overflow-x: auto;
                overflow-y: visible;
            }

            .control-section {
                min-width: auto;
                width: 100%;
            }

            #cinemaCanvas {
                width: 960px !important;
                height: 720px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎬 电影院选座系统</h1>
            <p>体验最佳的观影选座服务</p>
            <div class="user-section">
                <!-- 用户未登录状态 -->
                <div id="loginSection" class="login-section">
                    <button class="login-btn" onclick="openLoginModal()">🔑 登录 / 注册</button>
                </div>
                <!-- 用户已登录状态 -->
                <div id="userSection" class="user-info" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">用户名</span>
                    <button class="logout-btn" onclick="logout()">退出</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="cinema-section">
                <div class="screen">🎥 银幕 SCREEN 🎥</div>
                <!-- 影院配置 -->
                <div class="config-section">
                    <h3>🏛️ 影院配置</h3>
                    <div class="cinema-config">
                        <div class="form-group">
                            <label for="totalSeats">总座位数</label>
                            <select id="totalSeats">
                                <option value="100">100座</option>
                                <option value="200" selected>200座</option>
                                <option value="300">300座</option>
                            </select>
                        </div>
                        <button class="btn" onclick="updateCinemaLayout()">更新布局</button>
                    </div>
                </div>
                <canvas id="cinemaCanvas" width="960" height="720"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #27ae60;"></div>
                        <span>空座位</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffeb3b;"></div>
                        <span>已选座位</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>他人已售</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e67e22;"></div>
                        <span>他人预订</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c; border: 3px solid #f39c12;"></div>
                        <span>我的购票</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e67e22; border: 3px solid #3498db;"></div>
                        <span>我的预订</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color"
                            style="background-color: #ff6b6b; border: 5px solid #ffd700; box-shadow: 0 0 8px #ffd700;">
                        </div>
                        <span>我的票(选中)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color"
                            style="background-color: #95a5a6; border: 2px solid #e74c3c; position: relative;">
                            <span
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8px;">🚫</span>
                        </div>
                        <span>年龄限制</span>
                    </div>
                </div>
                <!-- 选座信息 -->
                <div class="selected-seats" id="selectedSeatsInfo">
                    <h4>📍 已选座位</h4>
                    <div class="seat-info" id="seatDetails">请选择座位</div>
                </div>
            </div>

            <div class="control-section">

                <!-- 购票选项 -->
                <div class="control-panel">
                    <h3>🎫 购票选项</h3>
                    <div class="form-group">
                        <label for="ticketType">票种类型</label>
                        <select id="ticketType" onchange="toggleTicketType()">
                            <option value="individual">个人票</option>
                            <option value="group">团体票</option>
                        </select>
                    </div>

                    <!-- 个人票表单 -->
                    <div id="individualForm">
                        <div class="form-group">
                            <label for="customerName">姓名</label>
                            <input type="text" id="customerName" placeholder="请输入姓名">
                        </div>
                        <div class="form-group">
                            <label for="customerAge">年龄</label>
                            <input type="number" id="customerAge" placeholder="请输入年龄" min="1" max="120">
                        </div>
                    </div>

                    <!-- 团体票表单 -->
                    <div id="groupForm" style="display: none;">
                        <div class="form-group">
                            <label for="groupSize">团体人数 (最多20人)</label>
                            <input type="number" id="groupSize" placeholder="请输入人数" min="2" max="20"
                                onchange="updateGroupMembers()">
                        </div>
                        <div class="group-members" id="groupMembers"></div>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-success" onclick="autoSelectSeats()">🤖 自动选座</button>
                        <button class="btn" onclick="clearSelection()">🧹 清空选择</button>
                    </div>
                </div>

                <!-- 用户票据信息 -->
                <div class="control-panel">
                    <h3>🎟️ 我的票据</h3>
                    <div class="ticket-records">
                        <div class="ticket-category">
                            <h5 style="color: #e67e22; margin-bottom: 10px;">📝 我的预订</h5>
                            <div id="userReservedList" class="ticket-list">暂无预订</div>
                        </div>
                        <div class="ticket-category" style="margin-top: 15px;">
                            <h5 style="color: #e74c3c; margin-bottom: 10px;">🎫 我的购票</h5>
                            <div id="userPurchasedList" class="ticket-list">暂无购票</div>
                        </div>
                        <button class="btn" onclick="refreshUserTickets()" style="margin-top: 10px;">🔄 刷新票据</button>
                    </div>
                </div>



                <!-- 操作按钮 -->
                <div class="control-panel">
                    <h3>💰 票务操作</h3>
                    <div class="info-panel">
                        <h4>💡 操作说明</h4>
                        <p><strong>手动选座：</strong> 点击座位进行单选</p>
                        <p><strong>多选：</strong> 按住Ctrl键+点击座位</p>
                        <p><strong>我的座位选中：</strong> 您的座位被选中时会有金色发光边框和★标记</p>
                        <p><strong>实时年龄限制：</strong> 输入年龄后，不可选座位会立即显示🚫标记并变灰</p>
                        <p><strong>年龄限制规则：</strong></p>
                        <p>• 少年(15岁以下)：不能坐前3排</p>
                        <p>• 老年人(60岁以上)：不能坐后3排</p>
                        <p>• 成年人：无限制</p>
                        <p>• 团体票：任一成员受限则该座位不可选</p>
                    </div>

                    <!-- 票价信息 -->
                    <div class="ticket-summary">
                        <h4>💵 票价信息</h4>
                        <div class="price-info">
                            <span>成人票：</span>
                            <span>¥45</span>
                        </div>
                        <div class="price-info">
                            <span>儿童票：</span>
                            <span>¥25</span>
                        </div>
                        <div class="price-info">
                            <span>老年票：</span>
                            <span>¥35</span>
                        </div>
                        <div class="total-price" id="totalPrice">总计：¥0</div>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-warning" onclick="reserveTickets()">📝 预订票</button>
                        <button class="btn btn-success" onclick="purchaseTickets()">💳 直接购票</button>
                        <button class="btn btn-danger" onclick="cancelReservation()">❌ 取消预订</button>
                        <button class="btn btn-danger" onclick="refundTickets()">💸 退票</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let canvas, ctx;
        let cinemaConfig = {
            totalSeats: 200,
            seatsPerRow: 20,
            rows: 10
        };
        let seats = [];
        let selectedSeats = [];
        let reservedSeats = new Set();
        let soldSeats = new Set();
        let ctrlPressed = false;

        // 用户票据管理
        let userTickets = {
            reserved: new Map(), // 用户预订的票 seat_number -> {name, age, timestamp}
            purchased: new Map() // 用户购买的票 seat_number -> {name, age, timestamp}
        };

        // 用户登录系统
        let currentUser = null; // 当前登录用户
        let userDatabase = {}; // 模拟用户数据库 (localStorage)

        // 用户数据存储键名
        const STORAGE_KEYS = {
            USERS: 'cinema_users',
            CURRENT_USER: 'cinema_current_user',
            USER_TICKETS: 'cinema_user_tickets'
        };

        // 座位状态常量
        const SEAT_STATUS = {
            AVAILABLE: 'available',
            SELECTED: 'selected',
            RESERVED: 'reserved',
            SOLD: 'sold'
        };

        // 票价配置
        const TICKET_PRICES = {
            adult: 45,      // 成人票
            child: 25,      // 儿童票  
            senior: 35      // 老年票
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            canvas = document.getElementById('cinemaCanvas');
            ctx = canvas.getContext('2d');

            // 初始化用户系统
            initializeUserSystem();

            initializeSeats();
            addEventListeners();

            // 添加一些模拟的已售座位
            addMockSoldSeats();

            // 在添加模拟数据后再绘制影院
            drawCinema();

            // 初始化用户票据显示
            refreshUserTickets();
        });

        // 添加事件监听器
        function addEventListeners() {
            canvas.addEventListener('click', handleSeatClick);

            // 监听Ctrl键
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Control') {
                    ctrlPressed = true;
                }
            });

            document.addEventListener('keyup', function (e) {
                if (e.key === 'Control') {
                    ctrlPressed = false;
                }
            });

            // 监听年龄输入变化，实时更新座位显示
            const customerAgeInput = document.getElementById('customerAge');
            if (customerAgeInput) {
                customerAgeInput.addEventListener('input', function () {
                    drawCinema(); // 重新绘制座位，应用年龄限制
                });
            }

            // 监听票务类型变化，重新绘制座位
            const ticketTypeSelect = document.getElementById('ticketType');
            if (ticketTypeSelect) {
                ticketTypeSelect.addEventListener('change', function () {
                    drawCinema(); // 重新绘制座位
                });
            }
        }

        // 初始化座位数据
        function initializeSeats() {
            seats = [];
            cinemaConfig.rows = Math.ceil(cinemaConfig.totalSeats / cinemaConfig.seatsPerRow);

            for (let row = 0; row < cinemaConfig.rows; row++) {
                seats[row] = [];
                for (let col = 0; col < cinemaConfig.seatsPerRow; col++) {
                    const seatNumber = row * cinemaConfig.seatsPerRow + col + 1;
                    if (seatNumber <= cinemaConfig.totalSeats) {
                        seats[row][col] = {
                            row: row + 1,
                            col: col + 1,
                            number: seatNumber,
                            status: SEAT_STATUS.AVAILABLE,
                            x: 0,
                            y: 0,
                            width: 0,
                            height: 0
                        };
                    }
                }
            }

            // 初始化座位后，动态调整Canvas尺寸
            updateCanvasSize();
        }

        // 动态更新Canvas尺寸
        function updateCanvasSize() {
            const margin = 50;
            const seatSize = 25;

            // 使用完全固定的Canvas尺寸，确保所有情况下座位大小一致
            const fixedCanvasWidth = 960; // 固定Canvas宽度
            const fixedCanvasHeight = 720; // 固定Canvas高度

            // 更新Canvas实际尺寸
            canvas.width = fixedCanvasWidth;
            canvas.height = fixedCanvasHeight;

            // 固定显示尺寸，1:1显示比例
            canvas.style.width = fixedCanvasWidth + 'px';
            canvas.style.height = fixedCanvasHeight + 'px';
        }

        // 绘制影院布局
        function drawCinema() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 使用固定的Canvas尺寸和布局参数
            const canvasWidth = 960; // 固定Canvas宽度
            const canvasHeight = 720; // 固定Canvas高度
            const margin = 50;
            const seatSize = 25;
            const seatGap = 3;

            // 弧形影院参数
            const centerX = canvasWidth / 2;
            const screenY = 80; // 银幕位置贴近画布上方

            // 弧形计算参数 - 调整基础半径以适应更松散的布局
            const baseRadius = 3200; // 增大基础半径以提供更多空间
            const screenRadius = baseRadius * 0.48; // 减小银幕弧线半径，让布局更紧凑
            const arcCenter = {
                x: centerX,
                // 调整圆心位置：让银幕弧线贴近顶部，同时确保座位布局合理
                y: screenY - screenRadius  // 银幕弧线最高点在screenY位置
            };

            // 计算座位的弧形角度范围，银幕将使用相同的角度
            const maxAngle = Math.PI / 8; // 36度，与座位相同
            const startAngle = (Math.PI - maxAngle) / 2; // 起始角度
            const endAngle = startAngle + maxAngle; // 结束角度

            // 绘制银幕（弧形）- 使用与座位相同的圆心角
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(arcCenter.x, arcCenter.y, screenRadius, startAngle, endAngle);
            ctx.stroke();

            // 添加银幕标识
            ctx.fillStyle = '#34495e';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            // ctx.fillText('🎬 银 幕 SCREEN 🎬', centerX, screenY + 20);

            for (let row = 0; row < cinemaConfig.rows; row++) {
                if (!seats[row]) continue;

                // 计算当前排的弧形半径（增大行间距使座位更松散）
                // 对于200座位（10排），第1排和第10排的半径比应为5:6
                // 设第1排半径为R，第10排半径为1.2R
                // currentRadius = baseRadius * 0.5 + row * increment
                // 第1排（row=0）: R = baseRadius * 0.5
                // 第10排（row=9）: 1.2R = baseRadius * 0.5 + 9 * increment
                // 因此：increment = (1.2R - R) / 9 = 0.2R / 9 = 0.2 * baseRadius * 0.5 / 9
                // 增大increment系数以增加行间距
                const increment = 0.01 * baseRadius; // 从0.2增加到0.3
                const currentRadius = baseRadius * 0.5 + row * increment;

                // 使用与银幕相同的角度范围
                const angleStep = maxAngle / (cinemaConfig.seatsPerRow - 1); // 每个座位的角度间隔

                for (let col = 0; col < cinemaConfig.seatsPerRow; col++) {
                    if (!seats[row][col]) continue;

                    const seat = seats[row][col];

                    // 计算当前座位的角度
                    const currentAngle = startAngle + col * angleStep;

                    // 根据角度和半径计算座位位置（极坐标转直角坐标）
                    const x = arcCenter.x + Math.cos(currentAngle) * currentRadius;
                    const y = arcCenter.y + Math.sin(currentAngle) * currentRadius;

                    // 更新座位坐标信息
                    seat.x = x - seatSize / 2; // 居中对齐
                    seat.y = y - seatSize / 2; // 居中对齐
                    seat.width = seatSize;
                    seat.height = seatSize;

                    // 绘制座位（传递角度信息和座位号用于旋转）
                    drawSeat(seat, seat.x, seat.y, seatSize, currentAngle, `${seat.row}-${seat.col}`);
                }

                // 绘制排号（在弧形的左侧，调整位置适应更松散的布局）
                const rowLabelAngle = startAngle - 0.02; // 稍微远离座位，让排号更清晰
                const rowLabelRadius = currentRadius + 10; // 增大间距，让排号更明显
                const labelX = arcCenter.x + Math.cos(rowLabelAngle) * rowLabelRadius;
                const labelY = arcCenter.y + Math.sin(rowLabelAngle) * rowLabelRadius;

                ctx.fillStyle = '#2c3e50'; // 使用更深的颜色，增强可读性
                ctx.font = 'bold 16px Arial'; // 稍微增大字体
                ctx.textAlign = 'center';
                // 清晰地显示排号，row=0是离银幕最近的第1排
                ctx.fillText(`${row + 1}排`, labelX, labelY);

                // 在右侧也显示排号，让排的边界更清楚
                const rightLabelAngle = endAngle + 0.02; // 右侧排号角度
                const rightLabelX = arcCenter.x + Math.cos(rightLabelAngle) * rowLabelRadius;
                const rightLabelY = arcCenter.y + Math.sin(rightLabelAngle) * rowLabelRadius;
                ctx.textAlign = 'center';
                ctx.fillText(`${row + 1}排`, rightLabelX, rightLabelY);
            }
        }

        // 绘制单个座位
        function drawSeat(seat, x, y, size, angle = 0, seatLabel = '') {
            let color;
            let borderColor = '#2c3e50';
            let borderWidth = 1;
            let hasUserMark = false;
            let isSelected = false;
            let hasGlow = false;

            // 检查是否是用户自己的票
            const isUserReserved = userTickets.reserved.has(seat.number);
            const isUserPurchased = userTickets.purchased.has(seat.number);
            const isCurrentlySelected = selectedSeats.some(s => s.number === seat.number) || seat.status === SEAT_STATUS.SELECTED;

            // 检查年龄限制是否让座位不可选
            const isAgeRestricted = isRestrictedByAge(seat);

            // 确定座位颜色和边框样式
            if (soldSeats.has(seat.number) || seat.status === SEAT_STATUS.SOLD) {
                if (isUserPurchased) {
                    // 用户自己的购票
                    if (isCurrentlySelected) {
                        // 被选中的用户购票座位 - 亮红色 + 闪亮金色边框 + 发光效果
                        color = '#ff6b6b';
                        borderColor = '#ffd700';
                        borderWidth = 5;
                        hasUserMark = true;
                        hasGlow = true;
                        isSelected = true;
                    } else {
                        // 未选中的用户购票座位 - 红色 + 橙色边框
                        color = '#e74c3c';
                        borderColor = '#f39c12';
                        borderWidth = 3;
                        hasUserMark = true;
                    }
                } else {
                    // 他人已售 - 纯红色
                    color = '#e74c3c';
                }
            } else if (reservedSeats.has(seat.number) || seat.status === SEAT_STATUS.RESERVED) {
                if (isUserReserved) {
                    // 用户自己的预订
                    if (isCurrentlySelected) {
                        // 被选中的用户预订座位 - 亮橙色 + 闪亮金色边框 + 发光效果
                        color = '#ff9500';
                        borderColor = '#ffd700';
                        borderWidth = 5;
                        hasUserMark = true;
                        hasGlow = true;
                        isSelected = true;
                    } else {
                        // 未选中的用户预订座位 - 橙色 + 蓝色边框
                        color = '#e67e22';
                        borderColor = '#3498db';
                        borderWidth = 3;
                        hasUserMark = true;
                    }
                } else {
                    // 他人预订 - 纯橙色
                    color = '#e67e22';
                }
            } else if (isCurrentlySelected) {
                // 普通选中座位
                if (isUserReserved || isUserPurchased) {
                    // 这种情况已在上面处理
                } else {
                    // 普通选中 - 亮黄色
                    color = '#ffeb3b';
                    borderColor = '#ff9800';
                    borderWidth = 2;
                }
            } else if (isAgeRestricted) {
                // 年龄限制座位 - 灰色 + 红色边框
                color = '#95a5a6';
                borderColor = '#e74c3c';
                borderWidth = 2;
            } else {
                color = '#27ae60'; // 绿色 - 空座
            }

            // 保存当前绘图状态
            ctx.save();

            // 计算座位中心点
            const centerX = x + size / 2;
            const centerY = y + size / 2;

            // 移动到座位中心点
            ctx.translate(centerX, centerY);

            // 计算旋转角度，使座位正对银幕
            // angle是座位相对于弧形中心的角度，我们需要让座位的"前方"（上边）指向银幕方向
            const rotationAngle = angle - Math.PI / 2; // 减去90度，让座位上边朝向弧形中心（银幕方向）
            ctx.rotate(rotationAngle);

            // 绘制发光效果（仅对选中的用户座位）
            if (hasGlow) {
                ctx.shadowColor = borderColor;
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }

            // 绘制座位背景（以座位中心为原点）
            ctx.fillStyle = color;
            ctx.fillRect(-size / 2, -size / 2, size, size);

            // 绘制座位边框
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = borderWidth;
            ctx.strokeRect(-size / 2, -size / 2, size, size);

            // 绘制座位细节（椅背）- 在座位的"前方"（上边）
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(-size / 2, -size / 2, size, 3); // 椅背

            // 绘制座位扶手
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(-size / 2, -size / 2 + 5, 3, size - 10); // 左扶手
            ctx.fillRect(size / 2 - 3, -size / 2 + 5, 3, size - 10); // 右扶手

            // 绘制座位号（在旋转后的坐标系中）
            if (seatLabel && !hasUserMark && !isAgeRestricted) {
                // 绘制座位号文字
                ctx.fillStyle = '#1a1a1a'; // 更深的颜色增强对比
                ctx.font = 'bold 9px Arial'; // 增大字体并加粗
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeStyle = '#ffffff'; // 白色描边
                ctx.lineWidth = 1;
                ctx.strokeText(seatLabel, 0, size / 2 - 8); // 先绘制描边
                ctx.fillText(seatLabel, 0, size / 2 - 8); // 再绘制填充
            }

            // 为用户自己的票添加特殊标记
            if (hasUserMark) {
                // 根据是否选中调整标记样式
                if (isSelected) {
                    // 选中状态：更大更醒目的标记
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                } else {
                    // 未选中状态：普通标记
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 8px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('我', 0, size / 4);
                }

                // 在用户座位上也显示座位号（在座位下方）
                if (seatLabel) {
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 8px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 0.5;
                    ctx.strokeText(seatLabel, 0, size / 2 - 8);
                    ctx.fillText(seatLabel, 0, size / 2 - 8);
                }
            }

            // 为年龄限制的座位添加禁止标记
            if (isAgeRestricted && !soldSeats.has(seat.number) && !reservedSeats.has(seat.number)) {
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('🚫', 0, 0);

                // 在年龄限制座位上也显示座位号
                if (seatLabel) {
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 8px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 0.5;
                    ctx.strokeText(seatLabel, 0, size / 2 - 8);
                    ctx.fillText(seatLabel, 0, size / 2 - 8);
                }
            }

            // 为选中的用户座位添加额外的视觉提示
            if (isSelected && hasUserMark) {
                // 在座位四角绘制小三角形
                ctx.fillStyle = borderColor;
                const triangleSize = 3;

                // 左上角
                ctx.beginPath();
                ctx.moveTo(-size / 2, -size / 2);
                ctx.lineTo(-size / 2 + triangleSize, -size / 2);
                ctx.lineTo(-size / 2, -size / 2 + triangleSize);
                ctx.closePath();
                ctx.fill();

                // 右上角
                ctx.beginPath();
                ctx.moveTo(size / 2, -size / 2);
                ctx.lineTo(size / 2 - triangleSize, -size / 2);
                ctx.lineTo(size / 2, -size / 2 + triangleSize);
                ctx.closePath();
                ctx.fill();

                // 左下角
                ctx.beginPath();
                ctx.moveTo(-size / 2, size / 2);
                ctx.lineTo(-size / 2 + triangleSize, size / 2);
                ctx.lineTo(-size / 2, size / 2 - triangleSize);
                ctx.closePath();
                ctx.fill();

                // 右下角
                ctx.beginPath();
                ctx.moveTo(size / 2, size / 2);
                ctx.lineTo(size / 2 - triangleSize, size / 2);
                ctx.lineTo(size / 2, size / 2 - triangleSize);
                ctx.closePath();
                ctx.fill();
            }

            // 恢复绘图状态
            ctx.restore();
        }        // 处理座位点击
        function handleSeatClick(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const clickX = (event.clientX - rect.left) * scaleX;
            const clickY = (event.clientY - rect.top) * scaleY;

            // 查找被点击的座位
            for (let row = 0; row < seats.length; row++) {
                if (!seats[row]) continue;
                for (let col = 0; col < seats[row].length; col++) {
                    if (!seats[row][col]) continue;

                    const seat = seats[row][col];
                    if (clickX >= seat.x && clickX <= seat.x + seat.width &&
                        clickY >= seat.y && clickY <= seat.y + seat.height) {

                        handleSeatSelection(seat);
                        return;
                    }
                }
            }
        }

        // 处理座位选择逻辑
        function handleSeatSelection(seat) {
            // 首先检查年龄限制
            if (isRestrictedByAge(seat) && !soldSeats.has(seat.number) && !reservedSeats.has(seat.number)) {
                const ticketType = document.getElementById('ticketType').value;
                let restrictionMsg = '';

                if (ticketType === 'individual') {
                    const age = parseInt(document.getElementById('customerAge').value);
                    if (age < 15 && seat.row <= 3) {
                        restrictionMsg = `少年（15岁以下）不能坐前三排！您当前年龄：${age}岁，该座位为第${seat.row}排。`;
                    } else if (age >= 60 && seat.row > cinemaConfig.rows - 3) {
                        restrictionMsg = `老年人（60岁以上）不能坐最后三排！您当前年龄：${age}岁，该座位为第${seat.row}排。`;
                    }
                } else if (ticketType === 'group') {
                    restrictionMsg = '团体中有成员因年龄限制无法选择此座位！请检查成员年龄设置。';
                }

                alert(restrictionMsg);
                return;
            }

            // 检查座位是否可选
            if (soldSeats.has(seat.number) || reservedSeats.has(seat.number)) {
                // 如果是用户自己的票，允许选择用于取消/退票
                const isUserReserved = userTickets.reserved.has(seat.number);
                const isUserPurchased = userTickets.purchased.has(seat.number);

                if (!isUserReserved && !isUserPurchased) {
                    alert('该座位已被他人占用！');
                    return;
                } else {
                    // 用户自己的票，可以选择用于退票/取消预订
                    const ticketInfo = isUserReserved ? userTickets.reserved.get(seat.number) : userTickets.purchased.get(seat.number);
                    const ticketType = isUserReserved ? '预订' : '已购买';

                    if (!confirm(`这是您${ticketType}的座位 (${ticketInfo.name})，选择此座位可进行退票操作。是否继续？`)) {
                        return;
                    }
                }
            } else {
                // 检查年龄限制（仅对新选座位）- 这里保留原有的交互式检查
                if (!checkAgeRestriction(seat)) {
                    return;
                }
            }

            const isSelected = selectedSeats.some(s => s.number === seat.number);

            if (ctrlPressed) {
                // 多选模式
                if (isSelected) {
                    selectedSeats = selectedSeats.filter(s => s.number !== seat.number);
                } else {
                    selectedSeats.push(seat);
                }
            } else {
                // 单选模式
                if (isSelected) {
                    selectedSeats = [];
                } else {
                    selectedSeats = [seat];
                }
            }

            updateSelectedSeatsDisplay();
            drawCinema();
            updateTotalPrice();
        }

        // 检查座位是否因年龄限制而不可选（用于UI显示）
        function isRestrictedByAge(seat) {
            const ticketType = document.getElementById('ticketType').value;

            if (ticketType === 'individual') {
                const age = parseInt(document.getElementById('customerAge').value);
                if (!age) return false; // 如果没有输入年龄，不限制

                // 少年（15岁以下）不能坐前三排
                if (age < 15 && seat.row <= 3) {
                    return true;
                }

                // 老年人（60岁以上）不能坐最后三排
                if (age >= 60 && seat.row > cinemaConfig.rows - 3) {
                    return true;
                }
            } else if (ticketType === 'group') {
                // 团体票需要检查所有成员的年龄限制
                const memberInfos = document.querySelectorAll('.member-info');

                for (let memberInfo of memberInfos) {
                    const ageInput = memberInfo.querySelector('.member-age');
                    if (ageInput && ageInput.value) {
                        const age = parseInt(ageInput.value);

                        // 如果有任何成员受年龄限制，该座位就不可选
                        if (age < 15 && seat.row <= 3) {
                            return true;
                        }
                        if (age >= 60 && seat.row > cinemaConfig.rows - 3) {
                            return true;
                        }
                    }
                }
            }

            return false;
        }

        // 检查年龄限制
        function checkAgeRestriction(seat) {
            const ticketType = document.getElementById('ticketType').value;

            if (ticketType === 'individual') {
                const age = parseInt(document.getElementById('customerAge').value);
                if (!age) return true; // 如果没有输入年龄，允许选择

                // 少年（15岁以下）不能坐前三排
                if (age < 15 && seat.row <= 3) {
                    alert('少年（15岁以下）不能坐前三排！');
                    return false;
                }

                // 老年人（60岁以上）不能坐最后三排
                if (age >= 60 && seat.row > cinemaConfig.rows - 3) {
                    alert('老年人（60岁以上）不能坐最后三排！');
                    return false;
                }
            }

            return true;
        }

        // 自动选座
        function autoSelectSeats() {
            const ticketType = document.getElementById('ticketType').value;

            if (ticketType === 'individual') {
                autoSelectIndividualSeat();
            } else {
                autoSelectGroupSeats();
            }
        }

        // 个人票自动选座
        function autoSelectIndividualSeat() {
            const name = document.getElementById('customerName').value.trim();
            const age = parseInt(document.getElementById('customerAge').value);

            if (!name || !age) {
                alert('请先填写姓名和年龄！');
                return;
            }

            selectedSeats = [];

            // 根据年龄确定可选择的排数范围
            let startRow = 1;
            let endRow = cinemaConfig.rows;

            if (age < 15) {
                startRow = 4; // 少年不能坐前三排
            } else if (age >= 60) {
                endRow = cinemaConfig.rows - 3; // 老年人不能坐后三排
            }

            // 查找最佳座位（优先选择中间位置）
            const preferredSeats = [];

            for (let row = startRow; row <= endRow; row++) {
                if (!seats[row - 1]) continue;

                for (let col = 1; col <= cinemaConfig.seatsPerRow; col++) {
                    const seat = seats[row - 1][col - 1];
                    if (!seat) continue;

                    if (!soldSeats.has(seat.number) && !reservedSeats.has(seat.number)) {
                        // 计算座位到中心的距离作为优先级参考
                        const centerCol = Math.ceil(cinemaConfig.seatsPerRow / 2);
                        const centerRow = Math.ceil(cinemaConfig.rows / 2);
                        const distance = Math.abs(seat.col - centerCol) + Math.abs(seat.row - centerRow);

                        preferredSeats.push({ seat, distance });
                    }
                }
            }

            if (preferredSeats.length === 0) {
                alert('没有符合年龄要求的可用座位！');
                return;
            }

            // 选择距离中心最近的座位
            preferredSeats.sort((a, b) => a.distance - b.distance);
            selectedSeats = [preferredSeats[0].seat];

            updateSelectedSeatsDisplay();
            drawCinema();
            updateTotalPrice();
        }

        // 团体票自动选座
        function autoSelectGroupSeats() {
            const groupSize = parseInt(document.getElementById('groupSize').value);

            if (!groupSize || groupSize < 2 || groupSize > 20) {
                alert('请输入有效的团体人数（2-20人）！');
                return;
            }

            // 获取团体成员信息
            const members = [];
            for (let i = 0; i < groupSize; i++) {
                const nameInput = document.getElementById(`memberName${i}`);
                const ageInput = document.getElementById(`memberAge${i}`);

                if (!nameInput || !ageInput || !nameInput.value.trim() || !ageInput.value) {
                    alert('请填写完整的团体成员信息！');
                    return;
                }

                members.push({
                    name: nameInput.value.trim(),
                    age: parseInt(ageInput.value)
                });
            }

            selectedSeats = [];

            // 确定团体的年龄限制
            const hasChild = members.some(m => m.age < 15);
            const hasSenior = members.some(m => m.age >= 60);

            let startRow = 1;
            let endRow = cinemaConfig.rows;

            if (hasChild) {
                startRow = 4; // 有少年，不能坐前三排
            }
            if (hasSenior) {
                endRow = cinemaConfig.rows - 3; // 有老年人，不能坐后三排
            }

            // 查找连续的座位
            for (let row = startRow; row <= endRow; row++) {
                if (!seats[row - 1]) continue;

                // 在每一排查找连续的空座位
                for (let startCol = 1; startCol <= cinemaConfig.seatsPerRow - groupSize + 1; startCol++) {
                    let consecutiveSeats = [];
                    let allAvailable = true;

                    for (let i = 0; i < groupSize; i++) {
                        const seat = seats[row - 1][startCol - 1 + i];
                        if (!seat || soldSeats.has(seat.number) || reservedSeats.has(seat.number)) {
                            allAvailable = false;
                            break;
                        }
                        consecutiveSeats.push(seat);
                    }

                    if (allAvailable) {
                        selectedSeats = consecutiveSeats;
                        updateSelectedSeatsDisplay();
                        drawCinema();
                        updateTotalPrice();
                        return;
                    }
                }
            }

            alert('无法找到满足条件的连续座位！请尝试减少人数或手动选择。');
        }

        // 更新已选座位显示
        function updateSelectedSeatsDisplay() {
            const seatDetails = document.getElementById('seatDetails');

            if (selectedSeats.length === 0) {
                seatDetails.innerHTML = '请选择座位';
                return;
            }

            let html = `<strong>已选 ${selectedSeats.length} 个座位：</strong><br>`;
            selectedSeats.forEach(seat => {
                html += `第${seat.row}排${seat.col}座 `;
            });

            seatDetails.innerHTML = html;
        }

        // 更新总价
        function updateTotalPrice() {
            let total = 0;
            const ticketType = document.getElementById('ticketType').value;

            if (ticketType === 'individual') {
                const age = parseInt(document.getElementById('customerAge').value);
                if (age && selectedSeats.length > 0) {
                    if (age < 15) {
                        total = selectedSeats.length * TICKET_PRICES.child;
                    } else if (age >= 60) {
                        total = selectedSeats.length * TICKET_PRICES.senior;
                    } else {
                        total = selectedSeats.length * TICKET_PRICES.adult;
                    }
                }
            } else {
                // 团体票根据成员年龄计算
                const groupSize = parseInt(document.getElementById('groupSize').value);
                if (groupSize && selectedSeats.length > 0) {
                    for (let i = 0; i < Math.min(groupSize, selectedSeats.length); i++) {
                        const ageInput = document.getElementById(`memberAge${i}`);
                        if (ageInput && ageInput.value) {
                            const age = parseInt(ageInput.value);
                            if (age < 15) {
                                total += TICKET_PRICES.child;
                            } else if (age >= 60) {
                                total += TICKET_PRICES.senior;
                            } else {
                                total += TICKET_PRICES.adult;
                            }
                        }
                    }
                }
            }

            document.getElementById('totalPrice').textContent = `总计：¥${total}`;
        }

        // 切换票种类型
        function toggleTicketType() {
            const ticketType = document.getElementById('ticketType').value;
            const individualForm = document.getElementById('individualForm');
            const groupForm = document.getElementById('groupForm');

            if (ticketType === 'individual') {
                individualForm.style.display = 'block';
                groupForm.style.display = 'none';
            } else {
                individualForm.style.display = 'none';
                groupForm.style.display = 'block';
            }

            // 清空选择
            clearSelection();
        }

        // 更新团体成员输入框
        function updateGroupMembers() {
            const groupSize = parseInt(document.getElementById('groupSize').value);
            const groupMembers = document.getElementById('groupMembers');

            if (!groupSize || groupSize < 2 || groupSize > 20) {
                groupMembers.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 0; i < groupSize; i++) {
                html += `
                    <div class="member-input member-info">
                        <input type="text" id="memberName${i}" placeholder="成员${i + 1}姓名">
                        <input type="number" id="memberAge${i}" class="member-age" placeholder="年龄" min="1" max="120" style="width: 80px;">
                    </div>
                `;
            }

            groupMembers.innerHTML = html;

            // 为新生成的年龄输入框添加事件监听器
            const ageInputs = groupMembers.querySelectorAll('.member-age');
            ageInputs.forEach(input => {
                input.addEventListener('input', function () {
                    drawCinema(); // 重新绘制座位，应用年龄限制
                });
            });
        }

        // 清空选择
        function clearSelection() {
            selectedSeats = [];
            updateSelectedSeatsDisplay();
            drawCinema();
            updateTotalPrice();
        }

        // 预订票
        function reserveTickets() {
            // 检查用户是否已登录
            if (!currentUser) {
                alert('请先登录后再预订座位！');
                openLoginModal();
                return;
            }

            if (selectedSeats.length === 0) {
                alert('请先选择座位！');
                return;
            }

            if (!validateCustomerInfo()) {
                return;
            }

            const ticketType = document.getElementById('ticketType').value;
            const timestamp = new Date().toLocaleString();

            // 将选中的座位添加到预订列表和用户票据
            selectedSeats.forEach(seat => {
                reservedSeats.add(seat.number);

                let ticketInfo;
                if (ticketType === 'individual') {
                    const name = document.getElementById('customerName').value.trim();
                    const age = parseInt(document.getElementById('customerAge').value);
                    ticketInfo = { name, age, timestamp, seat, userId: currentUser.username };
                } else {
                    // 团体票，使用第一个成员的信息作为代表
                    const name = document.getElementById('memberName0').value.trim();
                    const age = parseInt(document.getElementById('memberAge0').value);
                    ticketInfo = { name: name + '(团体)', age, timestamp, seat, userId: currentUser.username };
                }

                userTickets.reserved.set(seat.number, ticketInfo);

                // 保存到用户数据
                if (!currentUser.tickets) currentUser.tickets = [];
                currentUser.tickets.push({
                    ...ticketInfo,
                    status: 'reserved',
                    seatNumber: seat.number
                });
            });

            // 更新localStorage中的用户数据
            const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
            users[currentUser.username] = currentUser;
            localStorage.setItem('cinemaUsers', JSON.stringify(users));

            alert(`预订成功！已预订 ${selectedSeats.length} 个座位。\n预订时间：${timestamp}`);

            selectedSeats = [];
            updateSelectedSeatsDisplay();
            drawCinema();
            updateTotalPrice();
            refreshUserTickets();
        }

        // 直接购票
        function purchaseTickets() {
            // 检查用户是否已登录
            if (!currentUser) {
                alert('请先登录后再购买座位！');
                openLoginModal();
                return;
            }

            if (selectedSeats.length === 0) {
                alert('请先选择座位！');
                return;
            }

            if (!validateCustomerInfo()) {
                return;
            }

            const totalPrice = document.getElementById('totalPrice').textContent;
            const confirmed = confirm(`确认购买这些座位吗？\n${totalPrice}`);

            if (confirmed) {
                const ticketType = document.getElementById('ticketType').value;
                const timestamp = new Date().toLocaleString();

                // 将选中的座位添加到已售列表和用户票据
                selectedSeats.forEach(seat => {
                    soldSeats.add(seat.number);
                    reservedSeats.delete(seat.number); // 如果之前是预订状态，移除预订
                    userTickets.reserved.delete(seat.number); // 从用户预订中移除

                    let ticketInfo;
                    if (ticketType === 'individual') {
                        const name = document.getElementById('customerName').value.trim();
                        const age = parseInt(document.getElementById('customerAge').value);
                        ticketInfo = { name, age, timestamp, seat, userId: currentUser.username };
                    } else {
                        // 团体票，使用第一个成员的信息作为代表
                        const name = document.getElementById('memberName0').value.trim();
                        const age = parseInt(document.getElementById('memberAge0').value);
                        ticketInfo = { name: name + '(团体)', age, timestamp, seat, userId: currentUser.username };
                    }

                    userTickets.purchased.set(seat.number, ticketInfo);

                    // 保存到用户数据
                    if (!currentUser.tickets) currentUser.tickets = [];
                    currentUser.tickets.push({
                        ...ticketInfo,
                        status: 'purchased',
                        seatNumber: seat.number
                    });
                });

                // 更新localStorage中的用户数据
                const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
                users[currentUser.username] = currentUser;
                localStorage.setItem('cinemaUsers', JSON.stringify(users));

                alert(`购票成功！${totalPrice}\n购票时间：${timestamp}`);

                selectedSeats = [];
                updateSelectedSeatsDisplay();
                drawCinema();
                updateTotalPrice();
                refreshUserTickets();
            }
        }

        // 取消预订
        function cancelReservation() {
            // 检查用户是否已登录
            if (!currentUser) {
                alert('请先登录后再取消预订！');
                openLoginModal();
                return;
            }

            if (selectedSeats.length === 0) {
                alert('请先选择要取消预订的座位！');
                return;
            }

            let hasReserved = false;
            let canceledSeats = [];

            selectedSeats.forEach(seat => {
                if (userTickets.reserved.has(seat.number)) {
                    const ticket = userTickets.reserved.get(seat.number);

                    // 检查是否是当前用户的预订
                    if (ticket.userId !== currentUser.username) {
                        return; // 跳过不是当前用户的预订
                    }

                    reservedSeats.delete(seat.number);
                    userTickets.reserved.delete(seat.number);
                    canceledSeats.push(`第${seat.row}排${seat.col}座 (${ticket.name})`);

                    // 从用户票据记录中移除
                    if (currentUser.tickets) {
                        currentUser.tickets = currentUser.tickets.filter(t =>
                            !(t.seatNumber === seat.number && t.status === 'reserved')
                        );
                    }

                    hasReserved = true;
                }
            });

            if (hasReserved) {
                // 更新localStorage中的用户数据
                const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
                users[currentUser.username] = currentUser;
                localStorage.setItem('cinemaUsers', JSON.stringify(users));

                alert(`预订已取消！\n取消的座位：\n${canceledSeats.join('\n')}`);
                selectedSeats = [];
                updateSelectedSeatsDisplay();
                drawCinema();
                refreshUserTickets();
            } else {
                alert('所选座位中没有您预订的座位！');
            }
        }

        // 退票
        function refundTickets() {
            // 检查用户是否已登录
            if (!currentUser) {
                alert('请先登录后再退票！');
                openLoginModal();
                return;
            }

            if (selectedSeats.length === 0) {
                alert('请先选择要退票的座位！');
                return;
            }

            let hasSold = false;
            let refundedSeats = [];
            let totalRefund = 0;

            selectedSeats.forEach(seat => {
                if (userTickets.purchased.has(seat.number)) {
                    const ticket = userTickets.purchased.get(seat.number);

                    // 检查是否是当前用户的票
                    if (ticket.userId !== currentUser.username) {
                        return; // 跳过不是当前用户的票
                    }

                    soldSeats.delete(seat.number);
                    userTickets.purchased.delete(seat.number);
                    refundedSeats.push(`第${seat.row}排${seat.col}座 (${ticket.name})`);

                    // 计算退款金额
                    if (ticket.age < 15) {
                        totalRefund += TICKET_PRICES.child;
                    } else if (ticket.age >= 60) {
                        totalRefund += TICKET_PRICES.senior;
                    } else {
                        totalRefund += TICKET_PRICES.adult;
                    }

                    // 从用户票据记录中移除
                    if (currentUser.tickets) {
                        currentUser.tickets = currentUser.tickets.filter(t =>
                            !(t.seatNumber === seat.number && t.status === 'purchased')
                        );
                    }

                    hasSold = true;
                }
            });

            if (hasSold) {
                // 更新localStorage中的用户数据
                const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
                users[currentUser.username] = currentUser;
                localStorage.setItem('cinemaUsers', JSON.stringify(users));

                alert(`退票成功！退款金额：¥${totalRefund}\n退票座位：\n${refundedSeats.join('\n')}`);
                selectedSeats = [];
                updateSelectedSeatsDisplay();
                drawCinema();
                refreshUserTickets();
            } else {
                alert('所选座位中没有您购买的座位！');
            }
        }

        // 验证客户信息
        function validateCustomerInfo() {
            const ticketType = document.getElementById('ticketType').value;

            if (ticketType === 'individual') {
                const name = document.getElementById('customerName').value.trim();
                const age = document.getElementById('customerAge').value;

                if (!name) {
                    alert('请输入姓名！');
                    return false;
                }

                if (!age || age < 1 || age > 120) {
                    alert('请输入有效的年龄！');
                    return false;
                }
            } else {
                const groupSize = parseInt(document.getElementById('groupSize').value);

                if (!groupSize || groupSize < 2 || groupSize > 20) {
                    alert('请输入有效的团体人数！');
                    return false;
                }

                for (let i = 0; i < groupSize; i++) {
                    const nameInput = document.getElementById(`memberName${i}`);
                    const ageInput = document.getElementById(`memberAge${i}`);

                    if (!nameInput || !nameInput.value.trim()) {
                        alert(`请输入成员${i + 1}的姓名！`);
                        return false;
                    }

                    if (!ageInput || !ageInput.value || ageInput.value < 1 || ageInput.value > 120) {
                        alert(`请输入成员${i + 1}的有效年龄！`);
                        return false;
                    }
                }
            }

            return true;
        }

        // 更新影院布局
        function updateCinemaLayout() {
            const totalSeats = parseInt(document.getElementById('totalSeats').value);

            cinemaConfig.totalSeats = totalSeats;
            // 每排座位数固定为20座

            // 重新初始化
            initializeSeats();
            selectedSeats = [];
            reservedSeats.clear();
            soldSeats.clear();
            userTickets.reserved.clear();
            userTickets.purchased.clear();

            // 添加模拟的已售座位
            addMockSoldSeats();

            updateSelectedSeatsDisplay();
            drawCinema();
            updateTotalPrice();

            alert(`影院布局已更新：${totalSeats}座，每排20座`);
        }

        // 添加模拟的已售座位数据
        function addMockSoldSeats() {
            // 生成约31%的座位占用率
            const totalSeats = cinemaConfig.totalSeats;
            const soldCount = Math.floor(totalSeats * 0.31);

            // 清空现有数据
            soldSeats.clear();
            reservedSeats.clear();
            userTickets.purchased.clear();
            userTickets.reserved.clear();

            // 随机选择座位作为已售
            const seatNumbers = [];
            for (let i = 1; i <= totalSeats; i++) {
                seatNumbers.push(i);
            }

            // 打乱数组
            for (let i = seatNumbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [seatNumbers[i], seatNumbers[j]] = [seatNumbers[j], seatNumbers[i]];
            }

            // 选择前soldCount个座位作为已售
            for (let i = 0; i < soldCount; i++) {
                soldSeats.add(seatNumbers[i]);
            }

            // 添加一些预订座位（约5%）
            const reservedCount = Math.floor(totalSeats * 0.05);
            for (let i = soldCount; i < soldCount + reservedCount && i < seatNumbers.length; i++) {
                reservedSeats.add(seatNumbers[i]);
            }
        }

        // 用户系统相关函数

        // 打开登录模态框
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        // 关闭登录模态框
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            // 清空表单
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
            // 清空错误信息
            clearErrorMessages();
        }

        // 切换登录/注册标签
        function switchTab(tabName) {
            // 移除所有active类
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 添加active类到当前标签
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // 清空错误信息
            clearErrorMessages();
        }

        // 清空错误信息
        function clearErrorMessages() {
            document.querySelectorAll('.error-msg, .success-msg').forEach(msg => {

                msg.textContent = '';
                msg.classList.remove('show');
            });
        }

        // 显示错误信息
        function showErrorMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
                // 3秒后自动隐藏
                setTimeout(() => {
                    element.classList.remove('show');
                }, 3000);
            }
        }

        // 显示成功信息
        function showSuccessMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
                //  2秒后自动隐藏
                setTimeout(() => {
                    element.classList.remove('show');
                }, 2000);
            }
        }

        // 处理登录
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            // 清空之前的错误信息
            clearErrorMessages();

            // 基本验证
            if (!username) {
                showErrorMessage('loginUsernameError', '请输入用户名');
                return;
            }

            if (username.length < 3) {
                showErrorMessage('loginUsernameError', '用户名至少需要3个字符');
                return;
            }

            if (!password) {
                showErrorMessage('loginPasswordError', '请输入密码');
                return;
            }

            if (password.length < 6) {
                showErrorMessage('loginPasswordError', '密码至少需要6位字符');
                return;
            }

            // 从localStorage获取用户数据
            const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');

            if (!users[username]) {
                showErrorMessage('loginError', '❌ 用户不存在，请检查用户名或先注册账户');
                return;
            }

            if (users[username].password !== password) {
                showErrorMessage('loginError', '❌ 密码错误，请重新输入正确的密码');
                return;
            }

            // 登录成功
            currentUser = users[username];
            localStorage.setItem('currentUser', username);

            showSuccessMessage('loginSuccess', `🎉 登录成功！欢迎回来，${username}！`);
            setTimeout(() => {
                closeLoginModal();
                updateUserUI();
                refreshUserTickets();
            }, 1500);
        }

        // 处理注册
        function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const email = document.getElementById('registerEmail').value.trim();

            // 清空之前的错误信息
            clearErrorMessages();

            // 用户名验证
            if (!username) {
                showErrorMessage('registerUsernameError', '请输入用户名');
                return;
            }

            if (username.length < 3) {
                showErrorMessage('registerUsernameError', '用户名至少需要3个字符');
                return;
            }

            if (username.length > 20) {
                showErrorMessage('registerUsernameError', '用户名不能超过20个字符');
                return;
            }

            // 用户名格式验证（字母、数字、中文）
            const usernamePattern = /^[a-zA-Z0-9\u4e00-\u9fa5]+$/;
            if (!usernamePattern.test(username)) {
                showErrorMessage('registerUsernameError', '用户名只能包含字母、数字和中文字符');
                return;
            }

            // 密码验证
            if (!password) {
                showErrorMessage('registerPasswordError', '请输入密码');
                return;
            }

            if (password.length < 6) {
                showErrorMessage('registerPasswordError', '密码长度至少需要6位字符');
                return;
            }

            if (password.length > 50) {
                showErrorMessage('registerPasswordError', '密码长度不能超过50位字符');
                return;
            }

            // 确认密码验证
            if (!confirmPassword) {
                showErrorMessage('confirmPasswordError', '请确认密码');
                return;
            }

            if (password !== confirmPassword) {
                showErrorMessage('confirmPasswordError', '两次输入的密码不一致，请重新输入');
                return;
            }

            // 邮箱验证（如果填写了邮箱）
            if (email) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) {
                    showErrorMessage('registerEmailError', '请输入有效的邮箱格式');
                    return;
                }
            }

            // 检查用户名是否已存在
            const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');

            if (users[username]) {
                showErrorMessage('registerUsernameError', '❌ 用户名已存在，请选择其他用户名');
                return;
            }

            // 创建新用户
            const newUser = {
                username: username,
                password: password,
                email: email,
                tickets: [],
                registeredAt: new Date().toISOString()
            };

            users[username] = newUser;
            localStorage.setItem('cinemaUsers', JSON.stringify(users));

            showSuccessMessage('registerSuccess', `🎉 注册成功！欢迎加入，${username}！即将跳转到登录页面...`);
            setTimeout(() => {
                // 切换到登录标签
                switchTab('login');
                // 自动填充用户名
                document.getElementById('loginUsername').value = username;
                showSuccessMessage('loginSuccess', '💡 已为您自动填充用户名，请输入密码登录');
            }, 1500);
        }

        // 退出登录
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserUI();
            refreshUserTickets();

            // 清空当前选择的座位
            selectedSeats = [];
            updateSelectedSeatsDisplay();
            drawCinema();
            updateTotalPrice();
        }

        // 更新用户界面
        function updateUserUI() {
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');

            if (currentUser) {
                // 显示已登录状态
                loginSection.style.display = 'none';
                userSection.style.display = 'flex';
                userName.textContent = currentUser.username;
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            } else {
                // 显示未登录状态
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
            }
        }

        // 初始化用户系统
        function initializeUserSystem() {
            // 检查是否有已登录用户
            const currentUsername = localStorage.getItem('currentUser');
            if (currentUsername) {
                const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
                if (users[currentUsername]) {
                    currentUser = users[currentUsername];
                } else {
                    // 用户数据不存在，清除登录状态
                    localStorage.removeItem('currentUser');
                }
            }

            updateUserUI();
        }

        // 刷新用户票据显示
        function refreshUserTickets() {
            const reservedList = document.getElementById('userReservedList');
            const purchasedList = document.getElementById('userPurchasedList');

            if (!reservedList || !purchasedList) {
                return; // 如果元素不存在，直接返回
            }

            if (!currentUser) {

                // 用户未登录，清空显示
                reservedList.innerHTML = '<div class="ticket-empty">请登录查看票据信息</div>';
                purchasedList.innerHTML = '<div class="ticket-empty">请登录查看票据信息</div>';
                return;
            }

            // 显示预订票据
            if (userTickets.reserved.size === 0) {
                reservedList.innerHTML = '<div class="ticket-empty">暂无预订票据</div>';
            } else {
                let html = '';
                userTickets.reserved.forEach((ticket, seatNumber) => {
                    // 只显示当前用户的票据
                    if (ticket.userId === currentUser.username) {
                        html += `
                            <div class="ticket-item" onclick="selectUserSeat(${seatNumber})">
                                <strong>第${ticket.seat.row}排${ticket.seat.col}座</strong><br>
                                ${ticket.name} (${ticket.age}岁)<br>
                                <small>${ticket.timestamp}</small>
                            </div>
                        `;
                    }
                });
                reservedList.innerHTML = html || '<div class="ticket-empty">暂无预订票据</div>';
            }

            // 显示已购票据
            if (userTickets.purchased.size === 0) {
                purchasedList.innerHTML = '<div class="ticket-empty">暂无购票记录</div>';
            } else {
                let html = '';
                userTickets.purchased.forEach((ticket, seatNumber) => {
                    // 只显示当前用户的票据
                    if (ticket.userId === currentUser.username) {
                        html += `
                            <div class="ticket-item" onclick="selectUserSeat(${seatNumber})">
                                <strong>第${ticket.seat.row}排${ticket.seat.col}座</strong><br>
                                ${ticket.name} (${ticket.age}岁)<br>
                                <small>${ticket.timestamp}</small>
                            </div>
                        `;
                    }
                });
                purchasedList.innerHTML = html || '<div class="ticket-empty">暂无购票记录</div>';
            }
        }

        // ...existing code...
    </script>

    <!-- 登录/注册模态框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>用户中心</h2>
                <span class="close" onclick="closeLoginModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-tabs">
                    <button class="tab-btn active" onclick="switchTab('login')">登录</button>
                    <button class="tab-btn" onclick="switchTab('register')">注册</button>
                </div>

                <!-- 登录表单 -->
                <div id="loginTab" class="tab-content active">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="form-field">
                            <label for="loginUsername">用户名</label>
                            <input type="text" id="loginUsername" required minlength="3" maxlength="20">
                            <div class="error-msg" id="loginUsernameError"></div>
                        </div>
                        <div class="form-field">
                            <label for="loginPassword">密码</label>
                            <input type="password" id="loginPassword" required minlength="6">
                            <div class="error-msg" id="loginPasswordError"></div>
                        </div>
                        <button type="submit" class="submit-btn">登录</button>
                        <div class="error-msg" id="loginError"></div>
                        <div class="success-msg" id="loginSuccess"></div>
                    </form>
                </div>

                <!-- 注册表单 -->
                <div id="registerTab" class="tab-content">
                    <form id="registerForm" onsubmit="handleRegister(event)">
                        <div class="form-field">
                            <label for="registerUsername">用户名</label>
                            <input type="text" id="registerUsername" required minlength="3" maxlength="20"
                                pattern="[a-zA-Z0-9\u4e00-\u9fa5]+" title="用户名只能包含字母、数字和中文">
                            <div class="error-msg" id="registerUsernameError"></div>
                        </div>
                        <div class="form-field">
                            <label for="registerPassword">密码</label>
                            <input type="password" id="registerPassword" required minlength="6" maxlength="50">
                            <div class="error-msg" id="registerPasswordError"></div>
                        </div>
                        <div class="form-field">
                            <label for="confirmPassword">确认密码</label>
                            <input type="password" id="confirmPassword" required minlength="6" maxlength="50">
                            <div class="error-msg" id="confirmPasswordError"></div>
                        </div>
                        <div class="form-field">
                            <label for="registerEmail">邮箱 (可选)</label>
                            <input type="email" id="registerEmail" maxlength="100">
                            <div class="error-msg" id="registerEmailError"></div>
                        </div>
                        <button type="submit" class="submit-btn">注册</button>
                        <div class="error-msg" id="registerError"></div>
                        <div class="success-msg" id="registerSuccess"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>

</html>